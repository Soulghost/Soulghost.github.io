<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="iOS Jailbreak Principles 0x02 - codesign and amfid bypass"><meta name="keywords" content=""><meta name="author" content="高级页面仔 (Soulghost)"><meta name="copyright" content="高级页面仔 (Soulghost)"><title>iOS Jailbreak Principles 0x02 - codesign and amfid bypass | iOS Security Cabin</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#系列文章"><span class="toc-number">1.</span> <span class="toc-text">系列文章</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-number">2.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Codesign-Chain"><span class="toc-number">3.</span> <span class="toc-text">Codesign Chain</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#TrustCache"><span class="toc-number">3.1.</span> <span class="toc-text">TrustCache</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CoreTrust"><span class="toc-number">3.2.</span> <span class="toc-text">CoreTrust</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AMFI"><span class="toc-number">3.3.</span> <span class="toc-text">AMFI</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#绕过思路"><span class="toc-number">4.</span> <span class="toc-text">绕过思路</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#TrustCache-Poisoning"><span class="toc-number">4.1.</span> <span class="toc-text">TrustCache Poisoning</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CoreTrust-Bypass"><span class="toc-number">4.2.</span> <span class="toc-text">CoreTrust Bypass</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AMFI-Bypass"><span class="toc-number">4.3.</span> <span class="toc-text">AMFI Bypass</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#How-to-Debug-AMFI"><span class="toc-number">5.</span> <span class="toc-text">How to Debug AMFI</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AMFI-分析"><span class="toc-number">6.</span> <span class="toc-text">AMFI 分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#AMFI-绕过"><span class="toc-number">7.</span> <span class="toc-text">AMFI 绕过</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结"><span class="toc-number">8.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考资料"><span class="toc-number">9.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://avatars0.githubusercontent.com/u/6300263?s=460&amp;u=c55866a279854c9150528b358802a75be5e6a507&amp;v=4"></div><div class="author-info__name text-center">高级页面仔 (Soulghost)</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/Soulghost" target="_blank" rel="noopener">Follow Me on GitHub</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">11</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">19</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">iOS Security Cabin</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/about">About</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">iOS Jailbreak Principles 0x02 - codesign and amfid bypass</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-14</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="系列文章"><a href="#系列文章" class="headerlink" title="系列文章"></a>系列文章</h1><ol>
<li><a href="https://juejin.im/post/5df5f6416fb9a016402d1cc0" target="_blank" rel="noopener">iOS Jailbreak Principles - Undecimus 分析（一）Escape from Sandbox</a></li>
<li><a href="https://juejin.im/post/5e087dbd51882549757e5be2" target="_blank" rel="noopener">iOS Jailbreak Principles - Undecimus 分析（二）通过 String XREF 定位内核数据</a></li>
<li><a href="https://juejin.im/post/5e1ac76d51882520c02c82c0" target="_blank" rel="noopener">iOS Jailbreak Principles - Undecimus 分析（三）通过 IOTrap 实现内核任意代码执行</a></li>
<li><a href="https://juejin.im/post/5e415da86fb9a07c9a194f3b" target="_blank" rel="noopener">iOS Jailbreak Principles - Undecimus 分析（四）绕过 A12 的 PAC 实现 kexec</a></li>
<li><a href="https://juejin.im/post/5e8ad7ccf265da47b1778e17" target="_blank" rel="noopener">iOS Jailbreak Principles 0x01 - rootfs remount r/w 原理</a></li>
</ol>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>通过之前的文章我们介绍了从内核漏洞到 tfp0，再到根文件系统可读写的原理。单纯一个可读写的 rootfs 能做的事情还是非常有限的，为了能做更多事情我们往往要控制系统的 binary 或是分发自己的 binary 到系统。</p>
<p>为了能将自己或他人编写的 binary 在 iOS 上跑起来，我们必须越过代码签名这道大山。iOS 仅仅包含了有限的 binary 和系统级 App，他们的签名被 hardcode 在一份静态的 TrustCache 中，对于我们自己部署的 binary，例如用于修改密码的 passwd，以及用于 SSH 服务的 bash 和 dropbear，默认情况下是无法启动的，会被 amfid 直接 kill 掉。</p>
<h1 id="Codesign-Chain"><a href="#Codesign-Chain" class="headerlink" title="Codesign Chain"></a>Codesign Chain</h1><p>在 iOS 中，当运行一个 binary 时，系统会以责任链模式从多个角度检查代码签名，自 iOS 12 以后，整个代码签名主要包含三个部分：</p>
<ol>
<li>TrustCache: 一份 binary cdhash 的缓存，分为 static cache 和 dynamic cache 两部分，当 binary 的 cdhash 命中时直接放行；</li>
<li>CoreTrust: 内核基于 Apple 根证书对 binary 签名的合法性校验；</li>
<li>AMFI：即 MobileFileIntegrity，它会比对 binary 签名中存储的 cdhash 和 binary 实际 cdhash 是否相符。</li>
</ol>
<h2 id="TrustCache"><a href="#TrustCache" class="headerlink" title="TrustCache"></a>TrustCache</h2><p>Trustcache 本质上是 cdhash 的线性表，当 binary 执行时，系统首先计算出 binary 的 cdhash，随后对 TrustCache 进行二分查找，如果命中则直接放行。在 iOS 的 image 中包含了一份静态的 trustcache 用于加速系统 binary 的执行。</p>
<p>除去静态 trustcache 外，系统还会维护一份动态的 trustcache，用于处理 Xcode 为设备安装调试必须的 binary 的签名问题[1]。<strong>这其实是我们 bypass codesign 的一个简单方案</strong>。</p>
<h2 id="CoreTrust"><a href="#CoreTrust" class="headerlink" title="CoreTrust"></a>CoreTrust</h2><p>它主要保证了 binary 签名的合法性，即签名所使用的证书是由 Apple 根证书所签发的，这一机制使得非法签名和无签名的 binary 无法通过校验。</p>
<h2 id="AMFI"><a href="#AMFI" class="headerlink" title="AMFI"></a>AMFI</h2><p>如果 binary 未命中又通过了 CoreTrust 检查后（这里不考虑 CoreTrust Cache），就会将消息送达 AMFI 进行真正的 codesign 检查，这里的核心是通过 MISValidateSignatureAndCopyInfo 方法对 binary 的实际 cdhash 和签名中的 cdhash 进行验证。</p>
<h1 id="绕过思路"><a href="#绕过思路" class="headerlink" title="绕过思路"></a>绕过思路</h1><p>通过上面的讨论我们知道整个 codesign 责任链主要的三环：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TrustCache (static + dynamic cache lookup) → </span><br><span class="line">CoreTrust (deny fake signs, must sign with certs from apple) → </span><br><span class="line">AMFI (cdhash check)</span><br></pre></td></tr></table></figure>

<h2 id="TrustCache-Poisoning"><a href="#TrustCache-Poisoning" class="headerlink" title="TrustCache Poisoning"></a>TrustCache Poisoning</h2><p>最简单的方案就是篡改 dynamic TrustCache，我们首先通过 XREF 定位到 dynamic TrustCache 的全局变量，它是一个链表，链表的每一个结点都存储了一个或多个 binary 的 cdhash，且这些 cdhash 是以字典序升序排列的（用于支持二分查找）。</p>
<p>我们只需要找到 dynamic cache 的全局变量，为这个链表增加一个结点即可。这个在 rootlessJB 的 write-up[1] 以及各种开源 jailbreak 中有详细的论述和代码，主要的入手点在 <code>pmap_lookup_in_loaded_trust_caches</code>，本文不展开。</p>
<h2 id="CoreTrust-Bypass"><a href="#CoreTrust-Bypass" class="headerlink" title="CoreTrust Bypass"></a>CoreTrust Bypass</h2><p>在 rootlessJB 的 write-up 中提到 binary 在 CoreTrust 的校验也包含了一个基于 generation count 的缓存，但为了构造出合法的缓存可能需要模拟 XNU 中构造 cs_blob 的过程随后再设置一个合法的 generation count。这种方式虽然跳过了 AMFI，但较为复杂，并且向后兼容能力较差。</p>
<h2 id="AMFI-Bypass"><a href="#AMFI-Bypass" class="headerlink" title="AMFI Bypass"></a>AMFI Bypass</h2><p>AMFI 以 Mach Service 的形式提供对 codesign 的服务支持，既然是 C/S 架构，那么一个简单的方法就是伪造一个合法的响应，既然我们已经有了 tfp0，一个很直接的想法就是劫持 AMFI 的相关逻辑，并返回签名合法的消息。</p>
<p>本文将主要介绍 AMFI Bypass 的分析过程以及实施手段。</p>
<h1 id="How-to-Debug-AMFI"><a href="#How-to-Debug-AMFI" class="headerlink" title="How to Debug AMFI"></a>How to Debug AMFI</h1><p>在 iOS 11 以后，单纯给 debugserver 签上 <code>platform-application</code>, <code>task_for_pid-allow</code> 和 <code>com.apple.system-task-ports</code> 是依然无法 attach 到 system binary 的，因此默认情况下我们就无法调试 amfid。</p>
<p>为了能调试 system binary，我们必须在 spawn debugserver 时为它的 task 增加 <code>TF_PLATFORM</code> flag，其次为了断点能正常工作，我们需要为它的 proc 增加 <code>CS_DEBUGGED</code> flag：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">bool</span> <span class="title">patch_proc</span><span class="params">(<span class="keyword">uint64_t</span> proc)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*] patch proc 0x%llx"</span>, proc);</span><br><span class="line">    <span class="keyword">uint64_t</span> our_task = rk64(proc + <span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[*] find our task at 0x%llx\n"</span>, our_task);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">uint32_t</span> our_flags = rk32(our_task + <span class="number">0x3B8</span>);</span><br><span class="line">    wk32(our_task + <span class="number">0x3B8</span>, our_flags | <span class="number">0x00000400</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[+] give us TF_PLATFORM\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> our_csflags = rk32(proc + <span class="number">0x298</span>);</span><br><span class="line">    our_csflags = our_csflags | CS_DEBUGGED | CS_PLATFORM_BINARY | CS_INSTALLER | CS_GET_TASK_ALLOW;</span><br><span class="line">    our_csflags = our_csflags &amp; ~(CS_HARD | CS_KILL | CS_RESTRICT);</span><br><span class="line">    wk32(proc + <span class="number">0x298</span>, our_csflags);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[+] give us CS_PLATFORM_BINARY | CS_INSTALLER | CS_GET_TASK_ALLOW\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"[+] unrestrict our proc\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里需要用到 spawnAndPlatformize 的技术，这个技术包含在 QiLin ToolKit 中但没有开源，缺乏对 iOS 13 的支持，我们可以转而采用 jakeajames 开源在 rootlessJB 中的方法[3]：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">launchAsPlatform</span><span class="params">(<span class="keyword">char</span> *binary, <span class="keyword">char</span> *arg1, <span class="keyword">char</span> *arg2, <span class="keyword">char</span> *arg3, <span class="keyword">char</span> *arg4, <span class="keyword">char</span> *arg5, <span class="keyword">char</span> *arg6, <span class="keyword">char</span>**env)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pd;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* args[] = &#123;binary, arg1, arg2, arg3, arg4, arg5, arg6,  <span class="literal">NULL</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">posix_spawnattr_t</span> attr;</span><br><span class="line">    posix_spawnattr_init(&amp;attr);</span><br><span class="line">    posix_spawnattr_setflags(&amp;attr, POSIX_SPAWN_START_SUSPENDED); <span class="comment">//this flag will make the created process stay frozen until we send the CONT signal. This so we can platformize it before it launches.</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> rv = posix_spawn(&amp;pd, binary, <span class="literal">NULL</span>, &amp;attr, (<span class="keyword">char</span> **)&amp;args, env);</span><br><span class="line">    </span><br><span class="line">    platformize(pd);</span><br><span class="line">    </span><br><span class="line">    kill(pd, SIGCONT); <span class="comment">//continue</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!rv) &#123;</span><br><span class="line">        <span class="keyword">int</span> a;</span><br><span class="line">        waitpid(pd, &amp;a, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> rv;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="AMFI-分析"><a href="#AMFI-分析" class="headerlink" title="AMFI 分析"></a>AMFI 分析</h1><p>笔者这里以 iOS 13.1.1 的 iPad Air 2 为样本分析，我们可以从 iOS 设备的 <code>/usr/libexec/amfid</code> 找到 amfid binary，将它进行反编译后，我们从 main 入手分析：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall __noreturn <span class="title">start</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">char</span> **a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> **argv; <span class="comment">// x19</span></span><br><span class="line">  <span class="keyword">int</span> argc; <span class="comment">// w20</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v4; <span class="comment">// w8</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v5; <span class="comment">// w22</span></span><br><span class="line">  <span class="keyword">int</span> hasDFlag; <span class="comment">// w0</span></span><br><span class="line">  __int64 v7; <span class="comment">// x0</span></span><br><span class="line">  <span class="keyword">void</span> *v8; <span class="comment">// x8</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// w1</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// w21</span></span><br><span class="line">  <span class="keyword">int</span> *v11; <span class="comment">// x0</span></span><br><span class="line">  <span class="keyword">char</span> *v12; <span class="comment">// x0</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v13; <span class="comment">// x1</span></span><br><span class="line">  <span class="keyword">mach_port_t</span> server_port; <span class="comment">// [xsp+14h] [xbp-2Ch]</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_source_s</span> *<span class="title">context</span>;</span> <span class="comment">// [xsp+18h] [xbp-28h]</span></span><br><span class="line">  <span class="keyword">dispatch_object_t</span> v16; <span class="comment">// 0:x0.8</span></span><br><span class="line">  <span class="keyword">dispatch_object_t</span> v17; <span class="comment">// 0:x0.8</span></span><br><span class="line"></span><br><span class="line">  argv = a2;</span><br><span class="line">  argc = a1;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  context = (struct dispatch_source_s *)<span class="number">-6148914691236517206L</span>L;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v5 = v4;</span><br><span class="line">    hasDFlag = getopt(argc, argv, <span class="string">"d"</span>);</span><br><span class="line">    v4 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( hasDFlag == <span class="number">100</span> );</span><br><span class="line">  <span class="keyword">if</span> ( hasDFlag == <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = os_log_create(<span class="string">"com.apple.MobileFileIntegrity"</span>, <span class="string">"amfid"</span>);</span><br><span class="line">    v8 = &amp;_os_log_default;</span><br><span class="line">    <span class="keyword">if</span> ( v7 )</span><br><span class="line">      v8 = (<span class="keyword">void</span> *)v7;</span><br><span class="line">    amfi_logger = v8;</span><br><span class="line">    <span class="keyword">if</span> ( v5 )</span><br><span class="line">      v9 = <span class="number">33</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v9 = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v5 )</span><br><span class="line">      v10 = <span class="number">255</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v10 = <span class="number">63</span>;</span><br><span class="line">    openlog(<span class="string">"amfid"</span>, v9, <span class="number">24</span>);</span><br><span class="line">    setlogmask(v10);</span><br><span class="line">    syslog(<span class="number">6</span>, <span class="string">"starting"</span>);</span><br><span class="line">    server_port = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( bootstrap_check_in(bootstrap_port, <span class="string">"com.apple.MobileFileIntegrity"</span>, &amp;server_port) )</span><br><span class="line">    &#123;</span><br><span class="line">      v11 = __error();</span><br><span class="line">      v12 = strerror(*v11);</span><br><span class="line">      syslog(<span class="number">3</span>, <span class="string">"unable to checkin with launchd: %s"</span>, v12);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( server_port )</span><br><span class="line">    &#123;</span><br><span class="line">      v16._do = dispatch_source_create(</span><br><span class="line">                  (<span class="keyword">dispatch_source_type_t</span>)&amp;_dispatch_source_type_mach_recv,</span><br><span class="line">                  server_port,</span><br><span class="line">                  <span class="number">0L</span>L,</span><br><span class="line">                  (<span class="keyword">dispatch_queue_t</span>)&amp;_dispatch_main_q);</span><br><span class="line">      context = v16._do;</span><br><span class="line">      <span class="keyword">if</span> ( v16._do )</span><br><span class="line">      &#123;</span><br><span class="line">        dispatch_set_context(v16, &amp;context);</span><br><span class="line">        dispatch_source_set_event_handler_f(context, (<span class="keyword">dispatch_function_t</span>)amfi_server_port_event_handler);</span><br><span class="line">        v17._do = context;</span><br><span class="line">        dispatch_resume(v17);</span><br><span class="line">        dispatch_main();</span><br><span class="line">      &#125;</span><br><span class="line">      v13 = <span class="string">"could not create mig source"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v13 = <span class="string">"could not get mach port"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    syslog(<span class="number">3</span>, v13);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">fprintf</span>(__stderrp, <span class="string">"unrecognized argument '%c'\n"</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)optopt);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是一个 LaunchDaemon 的标准操作，通过 <code>bootstrap_port</code> 获取自己的 service port 并监听，重点看这一句：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dispatch_source_set_event_handler_f(context, (<span class="keyword">dispatch_function_t</span>)amfi_server_port_event_handler);</span><br></pre></td></tr></table></figure>

<p>这里我们得到了 server port 的 hander，我们跳转到 handler 进行分析：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">amfi_server_port_event_handler</span><span class="params">(_QWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _QWORD *v1; <span class="comment">// x20</span></span><br><span class="line">  __int64 v2; <span class="comment">// x19</span></span><br><span class="line">  __int64 v3; <span class="comment">// x0</span></span><br><span class="line"></span><br><span class="line">  v1 = a1;</span><br><span class="line">  syslog(<span class="number">7</span>, <span class="string">"%s: enter"</span>, <span class="string">"mig_source_handler"</span>);</span><br><span class="line">  v2 = os_transaction_create(<span class="string">"amfid mig server"</span>);</span><br><span class="line">  v3 = dispatch_mig_server(*v1, <span class="number">4184L</span>L, amfi_mig_server_handler);</span><br><span class="line">  <span class="keyword">if</span> ( (_DWORD)v3 )</span><br><span class="line">    syslog(<span class="number">3</span>, <span class="string">"%s: dispatch_mig_server returned %d"</span>, <span class="string">"mig_source_handler"</span>, v3);</span><br><span class="line">  syslog(<span class="number">7</span>, <span class="string">"%s: exit"</span>, <span class="string">"mig_source_handler"</span>);</span><br><span class="line">  <span class="keyword">return</span> _os_release(v2);</span><br></pre></td></tr></table></figure>

<p>可以看到这里包含了一个 mig server 的 handler，我们继续向下分析：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> __int64 __fastcall <span class="title">amfi_mig_server_handler</span><span class="params">(_DWORD *a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// w8</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// w8</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> some_index; <span class="comment">// w8</span></span><br><span class="line">  <span class="keyword">void</span> (__cdecl *v5)(_DWORD *, __int64); <span class="comment">// x8</span></span><br><span class="line">  <span class="keyword">signed</span> __int64 result; <span class="comment">// x0</span></span><br><span class="line"></span><br><span class="line">  *(_DWORD *)a2 = *a1 &amp; <span class="number">0x1F</span>;</span><br><span class="line">  v2 = a1[<span class="number">2</span>];</span><br><span class="line">  *(_DWORD *)(a2 + <span class="number">4</span>) = <span class="number">36</span>;</span><br><span class="line">  *(_DWORD *)(a2 + <span class="number">8</span>) = v2;</span><br><span class="line">  v3 = a1[<span class="number">5</span>] + <span class="number">100</span>;</span><br><span class="line">  *(_DWORD *)(a2 + <span class="number">16</span>) = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)(a2 + <span class="number">20</span>) = v3;</span><br><span class="line">  *(_DWORD *)(a2 + <span class="number">12</span>) = <span class="number">0</span>;</span><br><span class="line">  some_index = a1[<span class="number">5</span>] - <span class="number">1000</span>;</span><br><span class="line">  <span class="keyword">if</span> ( some_index &lt;= <span class="number">4</span></span><br><span class="line">    &amp;&amp; (v5 = (<span class="keyword">void</span> (__cdecl *)(_DWORD *, __int64))*(&amp;off_100004090 + <span class="number">5</span> * (<span class="keyword">signed</span> <span class="keyword">int</span>)some_index + <span class="number">5</span>)) != <span class="number">0L</span>L )</span><br><span class="line">  &#123;</span><br><span class="line">    v5(a1, a2);</span><br><span class="line">    result = <span class="number">1L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0L</span>L;</span><br><span class="line">    *(NDR_record_t *)(a2 + <span class="number">24</span>) = NDR_record;</span><br><span class="line">    *(_DWORD *)(a2 + <span class="number">32</span>) = <span class="number">-303</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里包含了一个 dispatch table，且 off_100004090 是跳转表的头部：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">some_index = a1[<span class="number">5</span>] - <span class="number">1000</span>;</span><br><span class="line"><span class="keyword">if</span> ( some_index &lt;= <span class="number">4</span></span><br><span class="line">&amp;&amp; (v5 = (<span class="keyword">void</span> (__cdecl *)(_DWORD *, __int64))*(&amp;off_100004090 + <span class="number">5</span> * (<span class="keyword">signed</span> <span class="keyword">int</span>)some_index + <span class="number">5</span>)) != <span class="number">0L</span>L )</span><br><span class="line">&#123;</span><br><span class="line">v5(a1, a2);</span><br><span class="line">result = <span class="number">1L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们看一下 off_100004090 的内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__const:0000000100004090 off_100004090   DCQ mig_server_handler_inner_1</span><br><span class="line">__const:0000000100004090                                         ; DATA XREF: mig_server_handler_inner_1+1C↑o</span><br><span class="line">__const:0000000100004090                                         ; amfi_mig_server_handler+38↑o</span><br><span class="line">&#x2F;&#x2F; ...</span><br><span class="line">__const:00000001000040B8                 DCQ mig_server_handler_inner_2</span><br><span class="line">&#x2F;&#x2F; ...</span><br><span class="line">__const:00000001000040E0                 DCQ mig_server_handler_inner_3</span><br></pre></td></tr></table></figure>

<p>我们可以看到这里包含了 3 个函数指针，基于不同的 index 会选择不同的 handler 去处理 xpc message。</p>
<p>这里我们可以采取动态调试的方法去寻找实际被调用的 handler：<br><img src="https://user-gold-cdn.xitu.io/2020/6/14/172b248730f69363?w=2880&h=1082&f=png&s=1852047" alt=""></p>
<p>这里我们可以看到实际用到的 handler 位于 0x00000001000032c8，即上面讨论中的 <code>mig_server_handler_inner_2</code>。</p>
<p>接下来顺着 <code>mig_server_handler_inner_2</code> 分析，它是一个 wrapper，关键部分如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__n128 __fastcall <span class="title">mig_server_handler_inner_2</span><span class="params">(NDR_record_t *ndr, __int64 a2)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    ret = amfi_verify_codesign(</span><br><span class="line">        a1 = ndr[<span class="number">1</span>].int_rep,     <span class="comment">// via w0</span></span><br><span class="line">        a2 = &amp;ndr[<span class="number">5</span>],            <span class="comment">// via x1 = binpath</span></span><br><span class="line">        a3 = ndr[<span class="number">8</span>].int_rep,     <span class="comment">// via x2</span></span><br><span class="line">        a4 = ndr[<span class="number">9</span>].int_rep,     <span class="comment">// via w3</span></span><br><span class="line">        a5 = ndr[<span class="number">10</span>].mig_vers,   <span class="comment">// via w4</span></span><br><span class="line">        a6 = ndr[<span class="number">10</span>].int_rep,    <span class="comment">// via w5</span></span><br><span class="line">        a7 = arg1 + <span class="number">0x24</span>,        <span class="comment">// via x6</span></span><br><span class="line">        a8 = arg1 + <span class="number">0x28</span>,        <span class="comment">// via x7, switch keypoint</span></span><br><span class="line">        a9 = arg1 + <span class="number">0x2c</span>,        <span class="comment">// via x10</span></span><br><span class="line">        a10 = arg1 + <span class="number">0x30</span>,       <span class="comment">// via x9</span></span><br><span class="line">        a11 = arg1 + <span class="number">0x34</span>,       <span class="comment">// via x11</span></span><br><span class="line">        a12 = arg1 + <span class="number">0x38</span>,       <span class="comment">// via x12</span></span><br><span class="line">        a13 = arg1 + <span class="number">0x44</span>,       <span class="comment">// via x20, return cdhash</span></span><br><span class="line">        a14 = &amp;sp_cdhash_bytes,  <span class="comment">// via x8</span></span><br><span class="line">        a15 = &amp;ndr[<span class="number">13</span>].int_rep   <span class="comment">// via x8-prev</span></span><br><span class="line">    );</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续跟进 <code>amfi_verify_codesign</code>，这里给出关键代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">uint64_t</span> __fastcall <span class="title">amfi_verify_codesign</span><span class="params">(__int64 a1, __int64 a2, __int64 a3, <span class="keyword">char</span> a4, __int64 a5, __int64 a6, _DWORD *a7, _DWORD *a8, _DWORD *a9, _DWORD *res_back_48, _DWORD *a11, _DWORD *a12, __int64 a13, __int64 cdhash_bytes, <span class="keyword">unsigned</span> <span class="keyword">int</span> *a15)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _DWORD *res_back_40; <span class="comment">// x19</span></span><br><span class="line">  <span class="keyword">char</span> v16; <span class="comment">// w20</span></span><br><span class="line">  __int64 bin_path; <span class="comment">// x23</span></span><br><span class="line">  <span class="keyword">uint64_t</span> return_val; <span class="comment">// x0</span></span><br><span class="line">  <span class="keyword">uint64_t</span> v19; <span class="comment">// x25</span></span><br><span class="line">  <span class="keyword">uint64_t</span> binary_path; <span class="comment">// x21</span></span><br><span class="line">  __int64 cfdict; <span class="comment">// x0</span></span><br><span class="line">  <span class="keyword">uint64_t</span> dict; <span class="comment">// x22</span></span><br><span class="line">  __int64 true_value; <span class="comment">// x26</span></span><br><span class="line">  <span class="keyword">uint64_t</span> longnum_v; <span class="comment">// x25</span></span><br><span class="line">  __int64 error; <span class="comment">// x0</span></span><br><span class="line">  __int64 v26; <span class="comment">// x25</span></span><br><span class="line">  __int64 v27; <span class="comment">// x0</span></span><br><span class="line">  __int64 v28; <span class="comment">// x24</span></span><br><span class="line">  __int64 v29; <span class="comment">// x23</span></span><br><span class="line">  __int64 cdhash; <span class="comment">// x23</span></span><br><span class="line">  __int64 res_dict; <span class="comment">// x25</span></span><br><span class="line">  <span class="keyword">uint64_t</span> singer_type; <span class="comment">// x0</span></span><br><span class="line">  __int64 cs_res_dict; <span class="comment">// [xsp+50h] [xbp-170h]</span></span><br><span class="line">  __int64 ndr_5_plus_reversed; <span class="comment">// [xsp+58h] [xbp-168h]</span></span><br><span class="line">  __int128 valuePtr; <span class="comment">// [xsp+60h] [xbp-160h]</span></span><br><span class="line">  __int128 v36; <span class="comment">// [xsp+70h] [xbp-150h]</span></span><br><span class="line">  __int128 v37; <span class="comment">// [xsp+80h] [xbp-140h]</span></span><br><span class="line">  __int128 v38; <span class="comment">// [xsp+90h] [xbp-130h]</span></span><br><span class="line">  __int128 v39; <span class="comment">// [xsp+A0h] [xbp-120h]</span></span><br><span class="line">  __int128 v40; <span class="comment">// [xsp+B0h] [xbp-110h]</span></span><br><span class="line">  __int128 v41; <span class="comment">// [xsp+C0h] [xbp-100h]</span></span><br><span class="line">  __int128 v42; <span class="comment">// [xsp+D0h] [xbp-F0h]</span></span><br><span class="line">  __int128 v43; <span class="comment">// [xsp+E0h] [xbp-E0h]</span></span><br><span class="line">  __int128 v44; <span class="comment">// [xsp+F0h] [xbp-D0h]</span></span><br><span class="line">  __int128 v45; <span class="comment">// [xsp+100h] [xbp-C0h]</span></span><br><span class="line">  __int128 v46; <span class="comment">// [xsp+110h] [xbp-B0h]</span></span><br><span class="line">  __int128 v47; <span class="comment">// [xsp+120h] [xbp-A0h]</span></span><br><span class="line">  __int128 v48; <span class="comment">// [xsp+130h] [xbp-90h]</span></span><br><span class="line">  __int128 v49; <span class="comment">// [xsp+140h] [xbp-80h]</span></span><br><span class="line">  __int128 v50; <span class="comment">// [xsp+150h] [xbp-70h]</span></span><br><span class="line">  __int64 v51; <span class="comment">// [xsp+168h] [xbp-58h]</span></span><br><span class="line"></span><br><span class="line">  res_back_40 = a8;</span><br><span class="line">  v16 = a4;</span><br><span class="line">  bin_path = a2;</span><br><span class="line">  ndr_5_plus_reversed = a3;</span><br><span class="line">  *a7 = <span class="number">0</span>;</span><br><span class="line">  *a8 = <span class="number">0</span>;</span><br><span class="line">  *res_back_48 = <span class="number">0</span>;</span><br><span class="line">  *a11 = <span class="number">0</span>;</span><br><span class="line">  *a12 = <span class="number">0</span>;</span><br><span class="line">  *a9 = <span class="number">0</span>;</span><br><span class="line">  *(_OWORD *)cdhash_bytes = <span class="number">0u</span>LL;               <span class="comment">// x24 = cdhash_bytes out</span></span><br><span class="line">  *(_DWORD *)(cdhash_bytes + <span class="number">16</span>) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(a15, &amp;unk_100003BB8, <span class="number">0x20</span>uLL) )</span><br><span class="line">  &#123;</span><br><span class="line">    v19 = kCFAllocatorDefault;</span><br><span class="line">    t</span><br><span class="line">    <span class="keyword">if</span> ( return_val )</span><br><span class="line">    &#123;</span><br><span class="line">      binary_path = return_val;</span><br><span class="line">      cfdict = CFDictionaryCreateMutable(v19, <span class="number">0L</span>L, &amp;kCFTypeDictionaryKeyCallBacks, &amp;kCFTypeDictionaryValueCallBacks);</span><br><span class="line">      <span class="keyword">if</span> ( cfdict )</span><br><span class="line">      &#123;</span><br><span class="line">        dict = cfdict;</span><br><span class="line">        true_value = kCFBooleanTrue;</span><br><span class="line">        CFDictionarySetValue(cfdict, kMISValidationOptionValidateSignatureOnly, kCFBooleanTrue);</span><br><span class="line">        CFDictionarySetValue(dict, kMISValidationOptionRespectUppTrustAndAuthorization, true_value);</span><br><span class="line">        longnum_v = CFNumberCreate(v19, <span class="number">0xB</span>uLL, &amp;ndr_5_plus_reversed);</span><br><span class="line">        CFDictionarySetValue(dict, kMISValidationOptionUniversalFileOffset, longnum_v);</span><br><span class="line">        CFRelease(longnum_v);</span><br><span class="line">        cs_res_dict = <span class="number">0L</span>L;</span><br><span class="line">        error = MISValidateSignatureAndCopyInfo(binary_path, dict, (<span class="keyword">uint64_t</span>)&amp;cs_res_dict);</span><br><span class="line">        <span class="keyword">if</span> ( (_DWORD)error )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">// error</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( cs_res_dict</span><br><span class="line">               &amp;&amp; (v29 = CFGetTypeID(), v29 == CFDictionaryGetTypeID())</span><br><span class="line">               &amp;&amp; (cdhash = CFDictionaryGetValue(cs_res_dict, kMISValidationInfoCdHash)) != <span class="number">0</span></span><br><span class="line">               &amp;&amp; (res_dict = CFGetTypeID(), res_dict == CFDataGetTypeID()) )</span><br><span class="line">        &#123;</span><br><span class="line">          CFDataGetBytes(cdhash, <span class="number">0L</span>L, <span class="number">20L</span>L, cdhash_bytes);</span><br><span class="line">          singer_type = CFDictionaryGetValue(cs_res_dict, kMISValidationInfoSignerType);</span><br><span class="line">          <span class="keyword">if</span> ( singer_type )</span><br><span class="line">          &#123;</span><br><span class="line">            *(_QWORD *)&amp;valuePtr = <span class="number">0L</span>L;</span><br><span class="line">            <span class="keyword">if</span> ( CFNumberGetValue(singer_type, <span class="number">0xE</span>uLL, &amp;valuePtr) )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">if</span> ( (_QWORD)valuePtr == <span class="number">5L</span>L )</span><br><span class="line">                *res_back_48 = <span class="number">5</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)os_log_type_enabled(amfi_logger, <span class="number">16L</span>L) )</span><br><span class="line">            &#123;</span><br><span class="line">              amfi_log_error_some(binary_path, &amp;cs_res_dict);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          *res_back_40 = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)os_log_type_enabled(amfi_logger, <span class="number">17L</span>L) )</span><br><span class="line">            amfi_log_error_some2(binary_path, dict, &amp;cs_res_dict);</span><br><span class="line">            *res_back_40 = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( cs_res_dict )</span><br><span class="line">          CFRelease(cs_res_dict);</span><br><span class="line">        <span class="keyword">if</span> ( v16 &amp; <span class="number">1</span> )</span><br><span class="line">          *res_back_40 = <span class="number">0</span>;</span><br><span class="line">        CFRelease(dict);</span><br><span class="line">      &#125;</span><br><span class="line">      return_val = CFRelease(binary_path);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// error</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> return_val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的几个关键部分如下：</p>
<ol>
<li>通过 <code>return_val = CFStringCreateWithFileSystemRepresentation(kCFAllocatorDefault, bin_path);</code> 我们可以知道 a2 是 binary path，它通过 ndr[5] 传入，被存储在 x23 中；</li>
<li>签名校验的关键逻辑在 libmis.dylib 的 <code>MISValidateSignatureAndCopyInfo</code> 中，函数必须返回 0 和合法的 dict 才能继续后面的校验；</li>
<li>通过 <code>CFDataGetBytes(cdhash, 0LL, 20LL, cdhash_bytes);</code> 完成了 binary cdhash 的拷贝，其中 cdhash_bytes 的地址存储在 x24 中；</li>
<li><code>res_back_40</code> 在出错时均写了 0，成功时写了 1，因此他应该代表校验的结果，它通过 a8 传入，通过分析 Caller 可知 a8 的地址被存储在 x19 中。</li>
</ol>
<p>基于上面的分析，我们的主要任务是伪造出 <code>res_back_40</code>，但经过实验发现单纯伪造 result 的 true/false 是不够的，我们还需要将 binary 实际的 cdhash 写入到 x24 对应的地址中才能完美的模拟 <code>amfi_verify_codesign</code> 从而通过签名校验。</p>
<h1 id="AMFI-绕过"><a href="#AMFI-绕过" class="headerlink" title="AMFI 绕过"></a>AMFI 绕过</h1><p>有了上面的分析我们知道，关键是要在 <code>amfi_verify_codesign</code> 中伪造三个东西：</p>
<ol>
<li>计算 binary 的真实 cdhash 并写到 x24 对应的 Caller Stack 地址，这个可以通过 x23 先拿到 binary path，调用 MIS 方法完成计算后写回；</li>
<li>劫持 MISValidateSignatureAndCopyInfo 使其返回 0；</li>
<li>将 <code>res_back_40</code> 置为 1。</li>
</ol>
<p>这些在 jakeajames 的 jelbrekLib 中已经有非常成熟的开源方案[4]，核心思路是获取 amfid 的 task port，为它设置一个 exception port，并将其 MISValidateSignatureAndCopyInfo 符号的地址写成非法值，当 AMFI 执行签名校验时，我们会收到 mach exception message，随后执行上述绕过操作，直接跳转到 <code>amfi_verify_codesign</code> 的 Epilogue 即可，这里给出几份代码实现的地址：</p>
<ol>
<li><a href="https://github.com/jakeajames/jelbrekLib/blob/master/amfid.m#L188" target="_blank" rel="noopener">https://github.com/jakeajames/jelbrekLib/blob/master/amfid.m#L188</a></li>
<li><a href="https://github.com/coolstar/Chimera13/blob/master/Chimera13/post-exploit/utils/amfidtakeover.swift#L164" target="_blank" rel="noopener">https://github.com/coolstar/Chimera13/blob/master/Chimera13/post-exploit/utils/amfidtakeover.swift#L164</a></li>
</ol>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>本文先简要分析了 iOS 12 以后的 codesign 机制，随后从 AMFI 入手分析了 AMFI 绕过方案的原理和实施过程。</p>
<p><img style="width: 320px;" src="https://user-gold-cdn.xitu.io/2019/8/24/16cc33a51b0a7319?w=1005&h=1164&f=png&s=197292"></img></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ol>
<li><a href="https://github.com/jakeajames/rootlessJB3/blob/master/writeup.pdf" target="_blank" rel="noopener">jakeajames: rootlessJB write-up</a></li>
<li><a href="http://newosxbook.com/articles/MDGA.html" target="_blank" rel="noopener">Jonathan Levin: Make Debugging Great Again</a></li>
<li><a href="https://github.com/jakeajames/rootlessJB_EL/blob/334ef9dfa9a04d0b9ca8ef4d2786c649b5971d51/empty_list/jelbrek/jelbrek.m#L245" target="_blank" rel="noopener">jakeajames: rootlessJB_EL - launchAsPlatform</a></li>
<li><a href="https://github.com/jakeajames/jelbrekLib/blob/master/amfid.m#L188" target="_blank" rel="noopener">jakeajames: jelbrekLib - amfid.m</a></li>
<li><a href="https://github.com/coolstar/Chimera13/blob/master/Chimera13/post-exploit/utils/amfidtakeover.swift#L164" target="_blank" rel="noopener">CoolStar: Chimera13 - amfidtakeover.swift</a></li>
</ol>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">高级页面仔 (Soulghost)</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://blog.asm.im/2020/06/14/iOS-Jailbreak-Principles-0x02-codesign-and-amfid-bypass/">http://blog.asm.im/2020/06/14/iOS-Jailbreak-Principles-0x02-codesign-and-amfid-bypass/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/07/05/iOS-Jailbreak-Principles-0x03-amfi-kext-%E7%9A%84%E5%8A%A0%E8%BD%BD%E5%92%8C%E5%B7%A5%E4%BD%9C%E8%BF%87%E7%A8%8B/"><i class="fa fa-chevron-left">  </i><span>iOS-Jailbreak-Principles-0x03-amfi-kext-的加载和工作过程</span></a></div><div class="next-post pull-right"><a href="/2020/04/06/iOS-Jailbreak-Principles-0x01-rootfs-remount-r-w-%E5%8E%9F%E7%90%86/"><span>iOS Jailbreak Principles 0x01 - rootfs remount r/w 原理</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2020 By 高级页面仔 (Soulghost)</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="footer_custom_text"><i class="fa fa-user"> 0xfffffff007004000</i><span class="footer-separator">|</span><i class="fa fa-eye"> 0x2004000</i></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>